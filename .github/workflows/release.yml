name: build-embedded-postgres

on:
  workflow_dispatch:
    inputs:
      pg_version:
        description: "Postgres version (e.g. 18.1)"
        required: false
        default: "18.1"
      pgvector_version:
        description: "pgvector git tag (e.g. v0.8.0)"
        required: false
        default: "v0.8.0"
      bundle_version:
        description: "Bundle version for artifact naming"
        required: false
        default: ""
  push:
    tags:
      - "v*"

jobs:
  darwin-arm64:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - name: Show runner arch
        run: |
          uname -a
          uname -m
      - name: Build
        env:
          PG_VERSION: ${{ inputs.pg_version || '18.1' }}
          PGVECTOR_VERSION: ${{ inputs.pgvector_version || 'v0.8.0' }}
          BUNDLE_VERSION: ${{ inputs.bundle_version }}
        run: |
          chmod +x scripts/*.sh
          if [ -z "${BUNDLE_VERSION}" ]; then
            export BUNDLE_VERSION="${PG_VERSION}"
          fi
          ./scripts/build_darwin_arm64.sh
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: embedded-postgres-darwin-arm64
          path: dist/*

