name: build-embedded-postgres

on:
  workflow_dispatch:
    inputs:
      pg_version:
        description: "Postgres version (e.g. 18.1)"
        required: false
        default: "18.1"
      pgvector_version:
        description: "pgvector git tag (e.g. v0.8.0)"
        required: false
        default: "v0.8.1"
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: darwin-arm64
            runner: macos-14
            platform: darwin
            arch: arm64
            archive_glob: "postgres-darwin-arm_64.tar.gz"
          - target: darwin-amd64
            runner: macos-15-intel
            platform: darwin
            arch: amd64
            archive_glob: "postgres-darwin-x86_64.tar.gz"
          - target: linux-amd64
            runner: ubuntu-latest
            platform: linux
            arch: amd64
            archive_glob: "postgres-linux-x86_64.tar.gz"
          - target: linux-arm64
            runner: ubuntu-24.04-arm
            platform: linux
            arch: arm64
            archive_glob: "postgres-linux-arm_64.tar.gz"

    runs-on: ${{ matrix.runner }}
    name: ${{ matrix.target }}

    steps:
      - uses: actions/checkout@v4

      - name: Show runner info
        run: |
          uname -a
          uname -m

      - name: Install Linux build dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential curl git pkg-config patchelf \
            zlib1g-dev xz-utils bzip2

      - name: Build
        env:
          PG_VERSION: ${{ inputs.pg_version || '18.1' }}
          PGVECTOR_VERSION: ${{ inputs.pgvector_version || 'v0.8.1' }}
          PLATFORM: ${{ matrix.platform }}
          ARCH: ${{ matrix.arch }}
        run: |
          chmod +x scripts/*.sh
          ./scripts/build.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: embedded-postgres-${{ matrix.target }}
          path: dist/*

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/${{ matrix.archive_glob }}
          generate_release_notes: true

  build-windows:
    runs-on: windows-latest
    name: windows-amd64

    steps:
      - uses: actions/checkout@v4

      - name: Show runner info
        run: systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"

      - name: Build
        shell: bash
        env:
          PG_VERSION: ${{ inputs.pg_version || '18.1' }}
          PGVECTOR_VERSION: ${{ inputs.pgvector_version || 'v0.8.1' }}
        run: |
          chmod +x scripts/*.sh
          ./scripts/build_windows.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: embedded-postgres-windows-amd64
          path: dist/*

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/postgres-windows-x86_64.tar.gz
          generate_release_notes: true
