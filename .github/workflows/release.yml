name: build-embedded-postgres

on:
  workflow_dispatch:
    inputs:
      pg_version:
        description: "Postgres version (e.g. 18.1)"
        required: false
        default: "18.1"
      pgvector_version:
        description: "pgvector git tag (e.g. v0.8.0)"
        required: false
        default: "v0.8.1"
      bundle_version:
        description: "Bundle version for artifact naming"
        required: false
        default: ""
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  darwin-arm64:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - name: Show runner arch
        run: |
          uname -a
          uname -m
      - name: Build
        env:
          PG_VERSION: ${{ inputs.pg_version || '18.1' }}
          PGVECTOR_VERSION: ${{ inputs.pgvector_version || 'v0.8.1' }}
          BUNDLE_VERSION: ${{ inputs.bundle_version }}
        run: |
          chmod +x scripts/*.sh
          if [ -z "${BUNDLE_VERSION}" ]; then
            if [[ "${GITHUB_REF:-}" == refs/tags/* ]]; then
              export BUNDLE_VERSION="${GITHUB_REF_NAME#v}"
            else
              export BUNDLE_VERSION="${PG_VERSION}"
            fi
          fi
          ./scripts/build_darwin_arm64.sh
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: embedded-postgres-darwin-arm64
          path: dist/*
      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/postgres-darwin-arm_64.txz
            dist/embedded-postgres-binaries-darwin-arm64v8-*.jar
          generate_release_notes: true
