name: build-embedded-postgres

on:
  workflow_dispatch:
    inputs:
      pg_version:
        description: "Postgres version (e.g. 18.1)"
        required: false
        default: "18.1"
      pgvector_version:
        description: "pgvector git tag (e.g. v0.8.0)"
        required: false
        default: "v0.8.1"
      bundle_version:
        description: "Bundle version for artifact naming"
        required: false
        default: ""
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: darwin-arm64
            runner: macos-14
            platform: darwin
            arch: arm64
            txz_glob: "postgres-darwin-arm_64.txz"
            jar_glob: "embedded-postgres-binaries-darwin-arm64v8-*.jar"
          - target: darwin-amd64
            runner: macos-13
            platform: darwin
            arch: amd64
            txz_glob: "postgres-darwin-x86_64.txz"
            jar_glob: "embedded-postgres-binaries-darwin-amd64-*.jar"
          - target: linux-amd64
            runner: ubuntu-latest
            platform: linux
            arch: amd64
            txz_glob: "postgres-linux-x86_64.txz"
            jar_glob: "embedded-postgres-binaries-linux-amd64-*.jar"

    runs-on: ${{ matrix.runner }}
    name: ${{ matrix.target }}

    steps:
      - uses: actions/checkout@v4

      - name: Show runner info
        run: |
          uname -a
          uname -m

      - name: Install Linux build dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential curl git pkg-config patchelf zip \
            zlib1g-dev xz-utils bzip2

      - name: Build
        env:
          PG_VERSION: ${{ inputs.pg_version || '18.1' }}
          PGVECTOR_VERSION: ${{ inputs.pgvector_version || 'v0.8.1' }}
          BUNDLE_VERSION: ${{ inputs.bundle_version }}
          PLATFORM: ${{ matrix.platform }}
          ARCH: ${{ matrix.arch }}
        run: |
          chmod +x scripts/*.sh
          if [ -z "${BUNDLE_VERSION}" ]; then
            if [[ "${GITHUB_REF:-}" == refs/tags/* ]]; then
              export BUNDLE_VERSION="${GITHUB_REF_NAME#v}"
            else
              export BUNDLE_VERSION="${PG_VERSION}"
            fi
          fi
          ./scripts/build.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: embedded-postgres-${{ matrix.target }}
          path: dist/*

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/${{ matrix.txz_glob }}
            dist/${{ matrix.jar_glob }}
          generate_release_notes: true
